
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>How to Maybe Flush WordPress's Rewrite Rules - Merge Conflicts</title>
	<meta name="author" content="Greg Boone">

	
	<meta name="description" content="How to Maybe Flush WordPress's Rewrite Rules Custom post types and taxonomies are one of the most powerful tools to transform WordPress from a &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Merge Conflicts" type="application/atom+xml">
	
	<link rel="canonical" href="http://gboone.github.io/blog/2013/08/24/how-to-maybe-flush-wordpresss-rewrite-rules/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	
</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("boone.greg@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
</div>

<p class="subtitle">Lessons in Web Development</p>
<nav id="main-nav"><!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>


<section class="aboutme">
  <p>
    I'm a web developer for Excella Consulting. I learn something new just about every day and write about it here.
  </p>
</section>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/gboone42" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/gboone" title="GitHub">GitHub</a>
		
		
		
		
		
		
		<a class="delicious" href="http://delicious.com/gboone42" title="Delicious">Delicious</a>
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">How to Maybe Flush WordPress's Rewrite Rules</h1>
	<div class="entry-content" itemprop="articleBody"><p>Custom post types and taxonomies are one of the most powerful tools to transform WordPress from a blogging platform to a full CMS. One of the most common problems beginning developers have when starting to use them is understanding how they work. It&rsquo;s easy to think that calling <code>register_post_type</code> is all it takes only to discover that their new post type archives are not working. This likely leads to a long dive into first (hopefully) the code to see if something was written incorrectly and then to the WordPress support forums to figure out what the problem is. 99% percent of the time I wager it&rsquo;s because the developer forgot to flush WordPress&rsquo;s rewrite rules.<!-- more --></p>

<p>The misunderstanding is in thinking that the &lsquo;register&rsquo; in <code>register_post_type</code> means there is some kind of database entry or global variable that completely installs the new post type. Not so. What it actually does is hook your new post types into the list of post types WordPress looks for on every page load. Even if you pass the <code>has_archive</code> and <code>rewrite</code> arguments, post type registration does not touch the rewrite <em>rules</em> that tell your webserver where and how to find the new post type, just what those rules should be once they are created.</p>

<p>Unlike post types, rewrite rules are stored in the database and are occasionally cached so they aren&rsquo;t pulled on every page load. The <code>wp_rewrite</code> row of the <code>wp_options</code> table might be quite large depending on what your permalink settings are, how many post types and taxonomies you have, and whether you have any rewrites going outside of WordPress. The only way to change the content of the global variable $wp_rewrite is to call <code>flush_rewrite_rules</code>, typically done by saving permalinks settings in wp-admin, this function clears the rewrite row and re-saves it.</p>

<p>Sometimes it isn&rsquo;t possible to click that button. Consider, for example, a production server without wp-admin accessible. How are you supposed to flush the rules? The <code>flush_rewrite_rules</code> function is costly, as noted in the codex, but must be hooked into <code>init</code> to work effectively. The problem is, flushing is expensive, espcially if you have a high-triffic website, and hooking to <code>init</code> means it will happen on every page load. What to do? Check if rewrite rules are correct and flush only if needed.</p>

<p>We have such a configuration at CFPB where wp-admin is generally inaccessible and we&rsquo;ve been struggling with exactly this problem every time we create a new post-type. I sloved the problem with a simple function called <a href="https://gist.github.com/gboone/6294720"><code>maybe_flush_rewrite</code></a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">maybe_flush_rewrite_rules</span><span class="p">(</span><span class="nv">$target</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$rules</span> <span class="o">=</span> <span class="nx">get_option</span><span class="p">(</span> <span class="s1">&#39;rewrite_rules&#39;</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="nv">$rules</span><span class="p">[</span> <span class="nv">$target</span> <span class="o">.</span> <span class="s1">&#39;/?$&#39;</span> <span class="p">]</span> <span class="o">!=</span>  <span class="s1">&#39;index.php?post_type=&#39;</span> <span class="o">.</span> <span class="nv">$target</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">flush_rewrite_rules</span><span class="p">(</span> <span class="nv">$hard</span> <span class="o">=</span> <span class="k">true</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// then pass the post type name to maybe flush rewrite rules</span>
</span><span class='line'><span class="nx">maybe_flush_rewrite_rules</span><span class="p">(</span> <span class="s1">&#39;your_post_type&#39;</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>YMMV with this function because I&rsquo;m guessing it may be dependent on your permalinks settings, but after poking around the content of the <code>wp_rewrite</code> table I realized that if a custom post type had an archive it would have a rewrite structure similar to <code>index.php?post_Type=&lt;post_type_name&gt;</code>. This function takes a post type name as the <code>$target</code> parameter, checks if it is registered, and flushes only if it is not in the rewrite table. Now you can register a post type and call <code>maybe_flush_rewrite_rules</code> anywhere to clear the rules only if needed.</p>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
			</div>
			<footer id="footer" class="inner"><div style="display:inline">
    Copyright &copy; 2014

    Greg Boone
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






		</div>
	</div>
</body>
</html>
